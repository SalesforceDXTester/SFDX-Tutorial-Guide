name: SFDX Build
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Salesforce SFDX CLI Action
        # You may pin to the exact commit or the version.
        # uses: sfdx-actions/setup-sfdx@d6a953fdfe15e4d05ca910870457536a36dc60fe
        uses: sfdx-actions/setup-sfdx@v1
        with:
          # Authorize a Salesforce org using an SFDX auth URL
          sfdx-auth-url: ${{ secrets.DEVHUB_URL }}

      # Sets default devhub to make scratch orgs and packages against
      - name: Set Default DevHub
        run: sfdx force:config:set defaultdevhubusername=mandradesf@protonmail.com
      # Creates a scratch org to test our org
      - name: Create Test Scratch org
        run: sfdx org:create:scratch -a actionsBuild -y 1 -d -f config/project-scratch-def.json

      # Push configurations to scratch
      - name: Push Source
        run: sfdx force:source:push -f

      # Run all apex tests
      - name: Run All Apex Tests
        run: sfdx apex:run:test -l RunLocalTests -w 30

      # Delete Scratch org upon completion
      - name: Delete Scratch Org
        run: sfdx org:delete:scratch -o actionsBuild -p
